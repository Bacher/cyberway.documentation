
## Назначение смарт-контракта cyber.stake
Системный смарт-контракт `cyber.stake` предоставляет данные о том, какими долями ресурсов владеют пользователи, а также о возможностях пользователей при голосовании с учетом этих ресурсов. Кроме этого, `cyber.stake` предоставляет возможность пользователю передавать права голоса другому пользователю.  

## Понятие прокси
Прокси (или прокси-аккаунт, от англ. proxy account) — аккаунт, который наделен определенным правом голоса во время голосования. В системе существуют прокси трех уровней. Количество прокси каждого из уровней не ограничено.  

Прокси может быть настроен на один из следующих уровней:
  * прокси нулевого уровня — прокси, наделенный голосами валидаторов, которые он может использовать во время голосования. Валидаторы, которые по каким-либо причинам не могут принимать участие в голосовании, передают ему свои голоса. 
  * прокси первого уровня — прокси, наделенный голосами других прокси, которые он может использовать во время голосовании.  
  * прокси третьего уровня — прокси, наделенный голосами пользователей, которые он может использовать во время голосования. Пользователи, которые по каким-либо причинам не могут принимать участие в голосовании, передают ему свои голоса.  
  
При передачи пользователем права голоса уровень прокси должен быть не ниже уровня этого пользователя. Введение уровней сделано для упрощения логики смарт-контракта, в том числе в части проверки на циклы в графе передачи прав.  

## Используемая терминология
 **Агент** — потенциально активный пользователь, имеющий баланс в смарт-контракте `cyber.stake`.  

**Голос, отданный за валидатора** — под голосом понимается проголосовавший токен (один токен соответствует одному голосу).  

**Делегатор** — пользователь, который делегирует средства другому пользователю.  

**Стейк**  (англ. stake) — определенное количество зарезервированных системных токенов, выделенных на выполнение определенной операции. В настоящем документе под стейком подразумеваются зарезервированная часть системных токены, выделенных исключительно на голосование за валидаторов.  

**Токен застейканный**  — символ токена, находящегося в состоянии стейка. По символу токена однозначно идентифицируется вид токена.  


## Операции-действия, применяемые в смарт-контракте cyber.stake
В состав смарт-контракта `cyber.stake` входят следующие операции-действия: [create](#operaciya-deistvie-create), [enable](#operaciya-deistvie-enable), [open](#operaciya-deistvie-open), [delegatevote](#operaciya-deistvie-delegatevote), [setgrntterms](#operaciya-deistvie-setgrntterms), [recallvote](#operaciya-deistvie-recallvote), [withdraw](#operaciya-deistvie-withdraw), [setproxylvl](#operaciya-deistvie-setproxylvl), [setproxyfee](#operaciya-deistvie-setproxyfee), [setminstaked](#operaciya-deistvie-setminstaked), [setkey](#operaciya-deistvie-setkey), [updatefunds](#operaciya-deistvie-updatefunds), [reward](#operaciya-deistvie-reward), [pick](#operaciya-deistvie-pick), [delegateuse](#operaciya-deistvie-delegateuse), [recalluse](#operaciya-deistvie-recalluse), [claim](#operaciya-deistvie-claim).

## Операция-действие create 
Операция используется для создания стейка для определенного символа токена.  
```cpp
void create(
    symbol token_symbol, 
    std::vector<uint8_t> max_proxies, 
    int64_t depriving_window, 
    int64_t min_own_staked_for_election
)
```  
**Параметры:**  
  * `token_symbol` — символ токена, для которого создается стейк.   
  * `max_proxies` — максимально допустимые значения прокси. Нулевой элемент вектора устанавливает максимально допустимое количество пользователей, которым можно поручить (делегировать) право голосования, если уровень прокси первый. Первый элемент вектора устанавливает максимально допустимое количество частей, на которое может быть разделен стэйк, если  уровень прокси второй.   
  * `depriving_window` — длительность периода (в секундах), в течение которого отозванные обратно делегатору средства не могут быть им использованы. Средства могут быть отозваны вызовом операции `recallvote`, например. Отозванные средства в течение данного периода не могут быть учитываться при расчете доли ресурсов. 
  * `min_own_staked_for_election` — минимально допустимое количество стейка, которое должен иметь пользователь, чтобы быть кандидатом в валидаторы.  

Обычные пользователи могут проголосовать либо за одного валидатора, либо передать право голосования только одному прокси.
Прокси может одновременно голосовать за несколько валидаторов. Максимально допустимое количество валидаторов, за которые прокси может голосовать — 30.  

Для вызова операции требуются права издателя токена `token_symbol`. Издатель токена, вызвав `create` дает возможность пользователям переводить токены данного вида в состояние стейка. При создании стейка для системного токена необходимо также обладать системными правами.  

## Операция-действие enable 
Операция устанавливает флаг `enable` в значение `true`. 

```cpp
void enable(symbol token_symbol) 
```   
Параметр `token_symbol`  — символ токена, на который действует установленный в значение `true` флаг `enable`.   

Данная операция используется в тестировании для отключения использования токенов определенного символа, чтобы они не были задействованы во время тестирования. На время тестирования флаг `enable` устанавливается в значение `false`, то есть отключается ограничение по ресурсам. По окончании тестирования флаг устанавливается в значение `true`. Если `token_symbol` является системным, то при установленном флаге `enable`, на ноде включается ограничение на использование ресурсов по стейку.  

Для вызова операции требуются права издателя токена `token_symbol`.  


## Операция-действие open 
Операция используется для открытия баланс для конкретного пользователя.  
```cpp
void open(
    name owner, 
    symbol_code token_code, 
    std::optional<name> ram_payer = std::nullopt
)
```  
**Параметры:**  
  * `owner` — имя пользователя, который открывает баланс.
  * `token_code` — символ токена, который будет содержаться на балансе. 
  * `ram_payer ` — имя аккаунта, который оплачивает открытие баланса. Если параметр принимает значение по умолчанию (std::nullopt), то открытие баланса оплачивает сам `owner`.   

Для вызова операции требуются права пользователя, который оплачивает открытие баланса. По умолчанию требуются права пользователя `owner`.  

## Операция-действие delegatevote 
Операция используется для делегирования права на использование стейка (или доли стейка) пользователем или прокси, которым они (пользователь или прокси) могут распоряжаться при голосовании за валидаторов.  

```cpp
void delegatevote(
    name grantor_name, 
    name recipient_name, 
    asset quantity
)
```  
  * `grantor_name` — имя аккаунта, который делегирует право на использование стейка (или доли стейка).
  * `recipient_name` — имя аккаунта, которому доверяется право голоса. Этим аккаунтом может быть прокси или пользователь с меньшим уровнем прокси.  
  * `quantity` — количество застейканных токенов, которыми аккаунт `recipient_name` может воспользоваться при голосовании.  

Пользователь может не принимать участие в голосовании за валидаторов, а передать свое право голоса другому пользователю или прокси, делегировав им свое право на использование определенного количества застейканных токенов. Эти токены (стейк) могут быть использованы только при голосовании за валидаторов.  

В зависимости от настроек стейка токена, этот токен может быть передан далее (вызовом `delegatevote`) получателю `recipient_name`, у которого уровень прокси `proxy_level` меньше, чем у отправителя `grantor_name`. При наличии трех прокси-уровней (валидатор, прокси, рядовой пользователь) прокси может только голосовать за валидатора. При наличии большего количества прокси-уровней, то прокси может передавать токены для голосования пользователю с более сильным уровнем.  

Стейк разделяется на несколько долей. Количество долей зависит от настроек стейка и ограничено значением `max_proxies`(см. операцию `create`). Для обычного пользователя это значение равно единице, дающее право пользователю проголосовать только за одного валидатора.  

Для вызова операции  `delegatevote` требуются права аккаунта `grantor_name`.  

## Операция-действие recallvote
Операция используется для возврата права на использование делегированного стейка при голосовании за валидаторов. Объем стейка, право на использование которого отзывается, измеряется в процентах и может быть указан как частично, так и полностью.  
```cpp
void recallvote(
    name grantor_name, 
    name recipient_name, 
    symbol_code token_code, 
    int16_t pct
)
```  
**Параметры:**  
  * `grantor_name` — имя аккаунта, который отзывает право на использование стейка (или доли стейка) при голосовании за валидаторов.
  * `recipient_name` — имя аккаунта, от которого отзывается право на использование стейка (доли стейка) при голосовании. 
  * `token_code` — символ застейканного токена.  
  * `pct` — доля стейка (в процентах), право на использование которой отзывается.  
Доля стейка, право на использование которой отзывается, может быть использовано аккаунтом `grantor_name` сразу по завершении операции `recallvote`.
 
Для вызова операции  `recallvote` требуются права аккаунта `grantor_name`.  

## Операция-действие setgrntterms
Операция используется для распределения дополнительно застейканных токенов между валидаторами при голосовании в соответствии с уже установленными пропорциями. 
```cpp
void setgrntterms(
    name grantor_name, 
    name recipient_name, 
    symbol_code token_code, 
    int16_t pct, 
    int16_t break_fee, 
    int64_t break_min_own_staked
)
```  
**Параметры:**  
  * `grantor_name` — имя аккаунта, который делегирует дополнительную долю стейка.
  * `recipient_name` — имя аккаунта, кандидата в валидаторыкоторый голосует за валидаторов делегируемой долей стейка. Под именем аккаунта может быть как прокси, так и валидатор.  
  * `token_code` — символ застейканных токенов.
  * `pct` — доля (в процентах) количества дополнительно полученных голосов, которая будет отдана за кандидата `recipient_name`.  
  * `break_fee` — параметр, контролирующий изменение комиссии `fee`, установленной кандидатом. Значение этого параметра — доля комиссии (в процентах), устанавливаемая аккаунтом `grantor_name` для кандидата `recipient_name`. Если кандидат установит  значение `fee` больше, чем `break_fee`, автоматически будет вызвана операция `recall` для отзыва голосов у данного кандидата.  
  * `break_min_own_staked` — параметр, контролирующий наличие застейканных токенов у кандидата `recipient_name`. Значение этого параметра устанавливается аккаунтом `grantor_name`. По умолчанию это изменение устанавливается равным текущему значению `min_own_staked`. Если кандидат уменьшит `min_own_staked` (с целью вывода средств), то при очередном обновлении баланса аккаунта `grantor_name` автоматически будет вызвана операция `recall` для отзыва застейканных токенов у данного кандидата.  

При выполнении `recall` проверяется условие, чтобы у кандидата оставались средства в размере не менее `min_own_staked`.  

Прокси может голосовать одновременно за нескольких кандидатов в валидаторы, распределяя голоса между ними в определенной пропорции. До завершения процесса голосования прокси может получить дополнительное количество голосов (застейканных токенов), которыми он также может воспользоваться. Эти дополнительные голоса автоматически будут отданы тем кандидатам, за которых голосовал прокси до получения этих голосов. Дополнительные голоса распределятся между кандидатами с сохранением пропорции.

## Операция-действие withdraw
Операция используется для вывода токенов из стейка в состояние ликвидного.
```cpp
void withdraw(
    name account, 
    asset quantity
)
```  
**Параметры:**  
  * `account` — имя аккаунта, который выводит токены из стейка.
  * `quantity` — количество выводимых токенов. Значение должно быть положительным.  

При вызове операции `withdraw` смарт-контракт `cyber.stake` отправляет уведомление издателю токена, который принимает окончательное решение о выводе токенов.  Вывод токенов выполняется сразу без какой-либо задержки.  

В случае вывода из стейка системного токена издателем токена является `cyber`. При этом решение о выводе токена принимает смарт-контракт `cyber.bios`. Перед выводом системного токена проверяется стоимость израсходованных пользователем ресурсов. Вывод выполняется, если объем остающихся у пользователя токенов в состоянии стейка за вычетом выводимого количества токенов покрывает затраты на израсходованные им ресурсы.  

Для вызова операции  `withdraw` требуются права аккаунта `account`.  

## Операция-действие setproxylvl
Операция устанавливает уровень прокси для определенного аккаунта.
```cpp
void setproxylvl(
    name account, 
    symbol_code token_code, 
    uint8_t level
)
```  
**Параметры:**  
  * `account` — имя аккаунта, которому устанавливается уровень прокси. 
  * `token_code` — количество токенов пользователя `account`, находящихся в состоянии стейка.
  * `level` — устанавливаемый уровень.  

Если пользователь намеревается получить статус кандидата в валидаторы, для него должен быть установлен нулевой уровень.  
Если пользователь намеревается получить статус прокси, для него должен быть установлен первый уровень.  

Для вызова операции  `setproxylvl` требуются права аккаунта `account`.  

## Операция-действие setproxyfee
Операция устанавливает размер комиссии для агента (кандидата в валидаторы), за которого голосовали пользователи.  
```cpp
void setproxyfee(
    name account, 
    symbol_code token_code, 
    int16_t fee
)
```  
**Параметры:**  
  * `account` — имя агента, за которого проголосовали пользователи.
  * `token_code` — символ токена, в виде которого выделяется вознаграждение агенту. 
  * `fee` — размер комиссионных отчислений от суммы вознаграждения, которые получает агент. Параметр рассчитывается в момент выплаты вознаграждения (в момент выполнения `reward`). Параметр принимает значения от «0» до «10000» включительно. Значение «0» соответствует «0 %», а «10000» соответствует «100 %».  

От поступившей суммы вознаграждения выделенной агенту отчисляется комиссия `fee` и передается агенту `account`. Остальная часть вознаграждения распределяется между всеми пользователями, проголосовавшими за данного агента.  

## Операция-действие setminstaked
Операция устанавливает минимально возможный размер стейка, выделяемого на голосовании самим агентом (кандидатом в валидаторы).  
```cpp
void setminstaked(
    name account, 
    symbol_code token_code, 
    int64_t min_own_staked
)
```  
**Параметры:**  
  * `account` — имя агента, кандидата в валидаторы. 
  * `token_code` — символ токена, находящегося в стейке..
  * `min_own_staked` — минимально возможный размер стейка, который выделяется на голосование самим агентом. Значение не может быть отрицательным.  

Если кандидат в валидаторы изменяет размер стейка и устанавливает значение `min_own_staked` меньше, чем `min_own_staked_for_election`, то отданные за него голоса автоматически аннулируются. 


## Операция-действие setkey
Операция устанавливает валидатору публичный ключ, который будет использоваться при подписании блоков.  
```cpp
void setkey(
    name account, 
    symbol_code token_code, 
    public_key signing_key
) 
```  
**Параметры:**  
  * `account` — имя валидатора, которому устанавливается публичный ключ.
  * `token_code` — символ застейканного токена.
  * `signing_key` — устанавливаемый публичный ключ (подпись валидатора).  


## Операция-действие updatefunds
Операция используется для обновления текущего размера стейка пользователя.  
```cpp
void updatefunds(
    name account, 
    symbol_code token_code
)
```  
**Параметры:**  
  * `account` — имя аккаунта, для которого изменяется размер стейка.
  * `token_code` — символ застейканного токена.  
  
Размер стейка пользователя может изменяться. Вызовом операции `updatefunds` устанавливается актуальное значение для размера стейка пользователя. Эта операция упрощает процедуру вычисления вознаграждения пользователей, в том числе позволяет определить долю, выделяемую для конкретного пользователя. Операция `updatefunds` вызывается также при выполнении других операций-действий, например, при выводе токенов или голосовании. То есть, при выполнении активных операций, требующих обновления стейка.  

Вызов операции `updatefunds` возможен любым пользователем. Авторизация при этом не требуется.  

## Операция-действие reward
Операция используется для выплаты вознаграждений пользователям с зачислением соответствующих сумм на их балансы.   
```cpp
void reward(
    std::vector<std::pair<name, int64_t> > rewards, 
    symbol sym
)
```  
**Параметры:**  
  * `rewards` — вектор, содержащий имена аккаунтов и соответствующие им выплаты.
  * `sym` — символ токенов, в которых выплачивается вознаграждение.  

Вызов операции требует авторизации издателя токенов.

## Операция-действие pick
Операция обновляет весь список валидаторов, в том числе кандидатов в валидаторы, и уведомляет контракт `cyber.stake` об изменениях в списке, а также о появлении нового валидатора, выбранного из числа кандидатов в определенный момент времени.  
```cpp
void pick(
    symbol_code token_code, 
    std::vector<name> accounts
)
```  
**Параметры:**  
  * `token_code` — количество токенов, находящихся у аккаунта, нотификация о котором отправляется.
  * `accounts` — вектор имен аккаунтов, являющихся актуальными валидаторами, а также кандидатами в валидаторы.  

Выбор валидаторов из числа кандидатов в валидаторы проводится в смарт-контракте `cyber.govern`. Первые `n-1` валидаторов из списка, где `n` — общее количество валидаторов, выбираются в соответствии с количеством отданных за них голосов с учетом веса каждого голоса. Последний валидатор из этого списка является псевдослучайным и выбирается в соответствии с установленной формулой, учитывающей длительность интервала, прошедшего с момента последнего выбора валидатора, и количество голосов, отданных за данного кандидата.  

Кандидаты в валидаторы, не получившие статус валидатора, но располагающиеся в списке в непосредственной близости от первых `n-1` валидаторов, получают возможность появиться в числе этих валидаторов через определенный интервал времени.  


Приоритеты кандидатов вычисляются в смарт-контракте `cyber.govern` с использованием метода `get_top`. Этот метод определяет выбранных кандидатов, получивших наибольшее количество голосов, и резервных кандидатов с учетом времени их пребывания в статусе кандидата (с какого времени кандидат остается среди невыбранных). Каждый из кандидатов располагается в списке поля `priority` в соответствии с вычисленным для него приоритетом.  

Операция `pick` вызывается смарт-контрактом `cyber.govern` и обновляет значение поля `priority`, передвигая всех кандидатов в очереди на позиции в соответствии с их  вычисленным приоритетом, и уведомляет `cyber.stake` об изменениях в списке кандидатов на текущий момент времени.  
 
Для вызова операции `pick` требуются права создателя токенов `token_code`.  


## Операция-действие delegateuse
Операция применяется для делегирования части стейка другому пользователю, который может использовать их при голосовании за валидаторов.  
```cpp
void delegateuse(
    name grantor_name, 
    name recipient_name, 
    asset quantity
) 
```  
**Параметры:**  
  * `grantor_name` —  имя аккаунта, делегатора части стейка.
  * `recipient_name` — имя аккаунта, получателя делегируемой части стейка.
  * `quantity` — количество делегируемого стейка. Значение должно быть положительным.  

Делегированная часть стейка не учитывается при расчетах голосов для делегатора, но учитывается при расчетах голосов для получателя этих средств.  

При вызове операции `delegateuse` смарт-контракт `cyber.stake` отправляет уведомление издателю токена, который принимает окончательное решение о делегировании стейка.  

В случае делегировании системного токена издателем токена является `cyber`. При этом решение о выводе токена принимает смарт-контракт `cyber.bios`. Перед делегированием системного токена проверяется стоимость израсходованных делегатором ресурсов. Делегирование выполняется, если остаток у делегатора части средств покрывает затраты на израсходованные им ресурсы.  


## Операция-действие recalluse
Операция используется для отзыва делегированной части стейка.  
```cpp
void recalluse(
    name grantor_name,
    name recipient_name,
    asset quantity
)
```  
**Параметры:**  
  * `grantor_name` — имя аккаунта, который отзывает делегируемую им часть стейка.
  * `recipient_name` — имя аккаунта, у которого отзывается делегируемая часть стейка.
  * `quantity` — количество отзываемой части стейка. Значение должно быть положительным.  

Делегированная часть стейка отзываются у получателя сразу и переходит в «замороженное» состояние. Длительность «замороженного» состояния определяется параметром `depriving_window` при вызове операции `create`. Делегатор может использовать возвращенную ему часть стейка только по истечении этого периода.


## Операция-действие claim
Операция используется для запроса на получение разрешения на использование отозванных делегированных средств.  
```cpp
void claim(
    name grantor_name,
    name recipient_name,
    symbol_code token_code
)
```  
**Параметры:**  
  * `grantor_name` — имя аккаунта, который отозвал делегируемую им часть стейка.
  * `recipient_name` — имя аккаунта, у которого была отозвана делегируемая часть стейка.
  * `token_code` — количество отзываемой части стейка. Значение должно быть положительным.  

По истечении срока пребывания в «замороженном» состоянии отозванных средств они могут быть использованы делегатором только после получения соответствующего разрешения. Вызов `claim` создает запрос на использование этих средств.  

Операция привязана ко времени восстановления ресурсов. Средства сразу возвращаются в полном объеме.  

Для выполнения операции требуется авторизация делегатора средств.  


****  

 